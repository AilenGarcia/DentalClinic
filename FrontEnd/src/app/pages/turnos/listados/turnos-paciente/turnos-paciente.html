<div class="container">
    <app-alert-banner></app-alert-banner>
    <h1>Mis Turnos M√©dicos</h1>
    <p class="sub">Consulta y gestiona tus citas m√©dicas</p>
    
    <div class="card">
        <h2>Lista de Turnos</h2>
        <div class="filters">
            <div class="form-group">
                <label>Odont√≥logo</label>
                <select [(ngModel)]="filtroOdontologo" (change)="aplicarFiltros()">
                    <option value="">Todos los odont√≥logos</option>
                    @for (odontologo of odontologos; track odontologo.id) {
                        <option [value]="odontologo.id">
                            {{odontologo.users.nombre}} {{odontologo.users.apellido}}
                        </option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" [(ngModel)]="filtroFecha" (change)="aplicarFiltros()" />
            </div>
            <button class="clear" (click)="limpiarFiltros()">Limpiar Filtros</button>
        </div>
    </div>

    @if (!this.cargando) {
        <table class="tabla">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Odont√≥logo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if(turnosPaginados.length === 0){
                    <tr>
                        <td class="empty" colspan="4">
                            {{(turnos.length > 0)
                            ?'No se han encontrado turnos con los par√°metros de b√∫squeda seleccionados.'
                            :'No tiene turnos agendados.'}}
                        </td>
                    </tr>
                } @else {
                    @for (t of turnosPaginados; track t.id) {
                        <tr>
                            <td>#{{ t.id }}</td>
                            <td>{{ t.fechaTurno.split('T')[0] }}</td>
                            <td>{{ t.horaTurno ? t.horaTurno.substring(0,5) : '‚Äî' }}</td>
                            <td>{{ t.odontologo.users.nombre }} {{ t.odontologo.users.apellido }}</td>
                            <td>
                                <button class="btn-ver" (click)="verDetalles(t)">Ver Detalles</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <div class="paginacion">
            <button (click)="paginaAnterior()" [disabled]="currentPage === 1">Anterior</button>
            <span>P√°gina {{currentPage}} de {{totalPages}}</span>
            <button (click)="paginaSiguiente()" [disabled]="currentPage === totalPages">Siguiente</button>
        </div>
    } @else {
        <div class="loading">
            <span class="spinner"></span> Cargando turnos...
        </div>
    }

    <button routerLink="/turnos/new" class="btn-nuevo">Agregar Nuevo Turno</button>
</div>

<!-- Modal de Detalles del Turno -->
@if (mostrarModal && turnoSeleccionado) {
    <div class="modal-overlay" (click)="cerrarModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Detalles del Turno</h2>
                <button class="btn-close" (click)="cerrarModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="detalle-section">
                    <h3>üìÖ Informaci√≥n del Turno</h3>
                    <div class="detalle-row">
                        <span class="detalle-label">Fecha:</span>
                        <span class="detalle-value">{{ formatearFecha(turnoSeleccionado.fechaTurno) }} - {{turnoSeleccionado.horaTurno}}</span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">ID del Turno:</span>
                        <span class="detalle-value">#{{ turnoSeleccionado.id }}</span>
                    </div>
                </div>

                <div class="detalle-section">
                    <h3>üë§ Paciente</h3>
                    <div class="detalle-row">
                        <span class="detalle-label">Nombre:</span>
                        <span class="detalle-value">
                            {{ turnoSeleccionado.paciente.users.nombre }} 
                            {{ turnoSeleccionado.paciente.users.apellido }}
                        </span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">DNI:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.paciente.dni }}</span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">Tel√©fono:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.paciente.telefono }}</span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">Email:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.paciente.users.email }}</span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">Domicilio:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.paciente.domicilio }}</span>
                    </div>
                </div>

                <div class="detalle-section">
                    <h3>ü¶∑ Odont√≥logo</h3>
                    <div class="detalle-row">
                        <span class="detalle-label">Nombre:</span>
                        <span class="detalle-value">
                            {{ turnoSeleccionado.odontologo.users.nombre }} 
                            {{ turnoSeleccionado.odontologo.users.apellido }}
                        </span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">Matr√≠cula:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.odontologo.matricula }}</span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">Especialidad:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.odontologo.descripcion }}</span>
                    </div>
                    <div class="detalle-row">
                        <span class="detalle-label">Email:</span>
                        <span class="detalle-value">{{ turnoSeleccionado.odontologo.users.email }}</span>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-eliminar" (click)="eliminarTurno(turnoSeleccionado)">
                    üóëÔ∏è Eliminar
                </button>
            </div>
        </div>
    </div>
}